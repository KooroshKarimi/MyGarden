<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ .Title }} · {{ .Site.Title }}</title>
    <style>
      body { max-width: 860px; margin: 2rem auto; padding: 0 1rem; font-family: system-ui, sans-serif; line-height: 1.6; }
      header { margin-bottom: 1.5rem; }
      h1 { margin-bottom: .3rem; }
      article h2 { font-size: 1.5rem; margin: 1.5rem 0 .5rem; }
      article h3 { font-size: 1.25rem; margin: 1.5rem 0 .5rem; border-bottom: 1px solid #eee; padding-bottom: .3rem; }
      article h4 { font-size: 1.1rem; margin: 1.2rem 0 .4rem; }
      .meta { color: #666; font-size: .9rem; }
      nav a { margin-right: .75rem; }
      .segments { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .8rem; margin: 1.25rem 0; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: .8rem; }
      .muted { color:#666; font-size:.95rem; }
      footer { margin-top: 3rem; font-size: .9rem; color: #666; }
      img { max-width: 100%; height: auto; }
      .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: .5rem; }
      .gallery img { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 4px; }
      figure { margin: 1rem 0; }
      figcaption { font-size: .85rem; color: #666; margin-top: .3rem; }
      .admin-avatar { position:absolute; top:0; right:0; cursor:pointer; width:36px; height:36px; border-radius:50%; overflow:hidden; display:none; text-decoration:none; }
      .admin-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
      .avatar-fallback { width:100%; height:100%; background:#2563eb; color:#fff; font-weight:700; font-size:1rem; display:flex; align-items:center; justify-content:center; }
      .admin-avatar:hover { box-shadow:0 0 0 2px #2563eb; }
      .editor-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; justify-content:center; align-items:center; }
      .editor-overlay.active { display:flex; }
      .editor-panel { background:#fff; border-radius:8px; padding:1.5rem; width:min(95vw,800px); max-height:90vh; overflow-y:auto; }
      .editor-panel h3 { margin-top:0; }
      .editor-field { margin-bottom:.75rem; }
      .editor-field label { display:block; font-weight:600; font-size:.85rem; margin-bottom:.2rem; }
      .editor-field input, .editor-field select, .editor-field textarea { width:100%; box-sizing:border-box; padding:.4rem; font-size:.9rem; border:1px solid #ccc; border-radius:4px; font-family:inherit; }
      .editor-field textarea { min-height:300px; font-family:monospace; resize:vertical; }
      .editor-actions { display:flex; gap:.5rem; margin-top:1rem; }
      .editor-actions button { padding:.5rem 1rem; border-radius:4px; border:1px solid #ccc; cursor:pointer; font-size:.9rem; }
      .editor-actions .save-btn { background:#2563eb; color:#fff; border-color:#2563eb; }
      .editor-actions .delete-btn { background:#dc2626; color:#fff; border-color:#dc2626; }
      .editor-status { margin-top:.75rem; font-size:.85rem; color:#555; }
      .ed-toolbar { display:flex; flex-wrap:wrap; gap:2px; margin-bottom:4px; }
      .ed-toolbar button { padding:3px 8px; font-size:.85rem; border:1px solid #ccc; border-radius:3px; background:#f5f5f5; cursor:pointer; font-family:monospace; line-height:1.3; }
      .ed-toolbar button:hover { background:#e0e0e0; }
      .ed-toolbar .sep { width:1px; background:#ddd; margin:0 4px; }
    </style>
  </head>
  <body>
    <header>
      <h1>{{ .Site.Title }}</h1>
      <p class="meta">{{ .Site.Params.description }}</p>
      <nav>
        <a href="{{ .Site.BaseURL }}">Start</a>
        <a href="{{ "politik/" | relURL }}">Politik</a>
        <a href="{{ "technik/" | relURL }}">Technik</a>
        <a href="{{ "reisen/" | relURL }}">Reisen</a>
        <a href="{{ "index.xml" | relURL }}">RSS</a>
        <span id="admin-nav" style="display:none">
          <span style="color:#ccc">|</span>
          <a href="/private/">Privat</a>
          <a href="/g/friends/">Friends</a>
          <a href="/g/family/">Family</a>
          <a href="/reader/">Reader</a>
        </span>
      </nav>
    </header>
    {{ block "main" . }}{{ end }}
    <footer>Built with Hugo</footer>
    <div class="editor-overlay" id="editor-overlay">
      <div class="editor-panel">
        <h3>Beitrag bearbeiten</h3>
        <div style="margin-bottom:.75rem;display:flex;align-items:center;gap:.75rem;">
          <div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;background:#eee;">
            <img id="ed-avatar-preview" src="/api/avatar/admin.jpg" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';">
          </div>
          <label style="cursor:pointer;font-size:.85rem;color:#2563eb;">
            Profilbild ändern
            <input type="file" id="ed-avatar-upload" accept="image/jpeg,image/png" style="display:none;">
          </label>
          <span id="ed-avatar-status" style="font-size:.8rem;color:#666;"></span>
        </div>
        <div class="editor-field"><label>Titel</label><input id="ed-title" type="text"></div>
        <div class="editor-field">
          <label>Typ</label>
          <select id="ed-type"><option value="note">note</option><option value="trip">trip</option><option value="timeline-entry">timeline-entry</option><option value="dossier">dossier</option><option value="article">article</option></select>
        </div>
        <div class="editor-field">
          <label>Segment</label>
          <select id="ed-segment"><option value="politik">politik</option><option value="technik">technik</option><option value="reisen">reisen</option></select>
        </div>
        <div class="editor-field">
          <label>Status</label>
          <select id="ed-status"><option value="seedling">seedling</option><option value="plant">plant</option><option value="tree">tree</option></select>
        </div>
        <div class="editor-field">
          <label>Sichtbarkeit</label>
          <select id="ed-visibility"><option value="public">public</option><option value="group">group</option><option value="private">private</option></select>
        </div>
        <div class="editor-field" id="ed-groups-field" style="display:none">
          <label>Gruppen (kommagetrennt)</label>
          <input id="ed-groups" type="text" placeholder="friends, family">
        </div>
        <div class="editor-field"><label>Datum</label><input id="ed-date" type="text" placeholder="2025-01-01"></div>
        <div class="editor-field"><label>Tags (kommagetrennt)</label><input id="ed-tags" type="text"></div>
        <div class="editor-field">
          <label>Inhalt (Markdown)</label>
          <div class="ed-toolbar">
            <button type="button" data-md="bold" title="Fett"><b>F</b></button>
            <button type="button" data-md="italic" title="Kursiv"><i>K</i></button>
            <button type="button" data-md="strikethrough" title="Durchgestrichen"><s>D</s></button>
            <span class="sep"></span>
            <button type="button" data-md="h2" title="Überschrift 2">H2</button>
            <button type="button" data-md="h3" title="Überschrift 3">H3</button>
            <button type="button" data-md="h4" title="Überschrift 4">H4</button>
            <span class="sep"></span>
            <button type="button" data-md="ul" title="Aufzählung">&#8226; Liste</button>
            <button type="button" data-md="ol" title="Nummerierte Liste">1. Liste</button>
            <button type="button" data-md="quote" title="Zitat">&gt; Zitat</button>
            <span class="sep"></span>
            <button type="button" data-md="link" title="Link">&#128279; Link</button>
            <button type="button" data-md="code" title="Code">&lt;/&gt;</button>
            <button type="button" data-md="hr" title="Trennlinie">&#8213;</button>
          </div>
          <textarea id="ed-body"></textarea>
        </div>
        <div class="editor-actions">
          <button class="save-btn" id="ed-save">Speichern</button>
          <button class="delete-btn" id="ed-delete">Loschen</button>
          <button id="ed-cancel">Abbrechen</button>
        </div>
        <div class="editor-status" id="ed-status-msg"></div>
      </div>
    </div>
    <script>
      (function(){
        var isAdmin = false;
        var contentPath = '';
        var extraFields = {};

        fetch('/api/admin-check',{credentials:'same-origin'})
          .then(function(r){
            if(r.ok){
              isAdmin = true;
              document.getElementById('admin-nav').style.display='inline';
              var btn = document.getElementById('edit-btn');
              if(btn) btn.style.display='block';
            }
          })
          .catch(function(){});

        // Avatar upload handler
        document.addEventListener('change', function(e){
          if(e.target.id !== 'ed-avatar-upload') return;
          var file = e.target.files[0];
          if(!file) return;
          var status = document.getElementById('ed-avatar-status');
          if(file.size > 1048576){
            status.textContent = 'Max 1 MB!';
            return;
          }
          if(file.type !== 'image/jpeg' && file.type !== 'image/png'){
            status.textContent = 'Nur JPEG/PNG!';
            return;
          }
          status.textContent = 'Hochladen...';
          fetch('/api/content/_avatar',{
            method:'PUT',
            credentials:'same-origin',
            headers:{'Content-Type': file.type},
            body: file
          })
          .then(function(r){ return r.json(); })
          .then(function(d){
            if(d.ok){
              status.textContent = 'Gespeichert!';
              var ts = '?t=' + Date.now();
              document.getElementById('ed-avatar-preview').src = '/api/avatar/admin.jpg' + ts;
              document.getElementById('ed-avatar-preview').style.display = '';
              var pageAvatar = document.getElementById('admin-avatar-img');
              if(pageAvatar){ pageAvatar.src = '/api/avatar/admin.jpg' + ts; pageAvatar.style.display = ''; }
            } else {
              status.textContent = 'Fehler: ' + d.error;
            }
          })
          .catch(function(err){ status.textContent = 'Fehler: ' + err; });
        });

        var overlay = document.getElementById('editor-overlay');
        var statusMsg = document.getElementById('ed-status-msg');
        var visSelect = document.getElementById('ed-visibility');
        var groupsField = document.getElementById('ed-groups-field');

        visSelect.addEventListener('change', function(){
          groupsField.style.display = visSelect.value === 'group' ? '' : 'none';
        });

        document.addEventListener('click', function(e){
          if(e.target.id === 'edit-btn' || e.target.closest('#edit-btn')){
            var btn = document.getElementById('edit-btn');
            contentPath = btn.getAttribute('data-content-path');
            loadContent(contentPath);
          }
        });

        function loadContent(path){
          statusMsg.textContent = 'Laden...';
          overlay.classList.add('active');
          fetch('/api/content/' + path, {credentials:'same-origin'})
            .then(function(r){ return r.json(); })
            .then(function(data){
              var fm = data.frontmatter || {};
              document.getElementById('ed-title').value = fm.title || '';
              document.getElementById('ed-type').value = fm.type || 'note';
              document.getElementById('ed-segment').value = fm.segment || 'politik';
              document.getElementById('ed-status').value = fm.status || 'seedling';
              document.getElementById('ed-visibility').value = fm.visibility || 'public';
              document.getElementById('ed-groups').value = Array.isArray(fm.groups) ? fm.groups.join(', ') : '';
              groupsField.style.display = fm.visibility === 'group' ? '' : 'none';
              document.getElementById('ed-date').value = fm.date || '';
              document.getElementById('ed-tags').value = Array.isArray(fm.tags) ? fm.tags.join(', ') : '';
              document.getElementById('ed-body').value = data.body || '';
              // preserve extra fields not shown in the form
              extraFields = {};
              var known = ['title','type','segment','status','visibility','groups','date','tags'];
              for(var k in fm){ if(known.indexOf(k)===-1) extraFields[k]=fm[k]; }
              statusMsg.textContent = '';
            })
            .catch(function(err){
              statusMsg.textContent = 'Fehler beim Laden: ' + err;
            });
        }

        document.getElementById('ed-cancel').addEventListener('click', function(){
          overlay.classList.remove('active');
        });

        document.getElementById('ed-save').addEventListener('click', function(){
          statusMsg.textContent = 'Speichern...';
          var fm = Object.assign({}, extraFields, {
            title: document.getElementById('ed-title').value,
            type: document.getElementById('ed-type').value,
            segment: document.getElementById('ed-segment').value,
            status: document.getElementById('ed-status').value,
            visibility: document.getElementById('ed-visibility').value,
            date: document.getElementById('ed-date').value
          });
          var tags = document.getElementById('ed-tags').value.split(',').map(function(t){return t.trim();}).filter(Boolean);
          if(tags.length) fm.tags = tags;
          if(fm.visibility === 'group'){
            fm.groups = document.getElementById('ed-groups').value.split(',').map(function(t){return t.trim();}).filter(Boolean);
          }
          fetch('/api/content/' + contentPath, {
            method:'PUT',
            credentials:'same-origin',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({frontmatter:fm, body:document.getElementById('ed-body').value})
          })
          .then(function(r){ return r.json().then(function(d){return {ok:r.ok, data:d};}); })
          .then(function(res){
            if(!res.ok){
              statusMsg.textContent = 'Fehler: ' + (res.data.details||[]).join(', ') || res.data.error;
              return;
            }
            statusMsg.textContent = 'Gespeichert. Rebuild lauft...';
            pollRebuild();
          })
          .catch(function(err){ statusMsg.textContent = 'Fehler: ' + err; });
        });

        document.getElementById('ed-delete').addEventListener('click', function(){
          if(!confirm('Diesen Beitrag wirklich loschen?')) return;
          statusMsg.textContent = 'Loschen...';
          fetch('/api/content/' + contentPath, {
            method:'DELETE',
            credentials:'same-origin'
          })
          .then(function(r){ return r.json().then(function(d){return {ok:r.ok, data:d};}); })
          .then(function(res){
            if(!res.ok){
              statusMsg.textContent = 'Fehler: ' + res.data.error;
              return;
            }
            statusMsg.textContent = 'Geloscht. Rebuild lauft...';
            pollRebuild();
          })
          .catch(function(err){ statusMsg.textContent = 'Fehler: ' + err; });
        });

        // Markdown toolbar
        document.querySelector('.ed-toolbar').addEventListener('click', function(e){
          var btn = e.target.closest('[data-md]');
          if(!btn) return;
          var ta = document.getElementById('ed-body');
          var start = ta.selectionStart, end = ta.selectionEnd;
          var sel = ta.value.substring(start, end);
          var before = ta.value.substring(0, start);
          var after = ta.value.substring(end);
          var insert = '', cursorOffset = 0;
          switch(btn.getAttribute('data-md')){
            case 'bold':
              insert = '**' + (sel || 'Text') + '**';
              cursorOffset = sel ? insert.length : 2;
              break;
            case 'italic':
              insert = '*' + (sel || 'Text') + '*';
              cursorOffset = sel ? insert.length : 1;
              break;
            case 'strikethrough':
              insert = '~~' + (sel || 'Text') + '~~';
              cursorOffset = sel ? insert.length : 2;
              break;
            case 'h2':
              insert = '\n## ' + (sel || 'Überschrift') + '\n';
              cursorOffset = sel ? insert.length : 4;
              break;
            case 'h3':
              insert = '\n### ' + (sel || 'Überschrift') + '\n';
              cursorOffset = sel ? insert.length : 5;
              break;
            case 'h4':
              insert = '\n#### ' + (sel || 'Überschrift') + '\n';
              cursorOffset = sel ? insert.length : 6;
              break;
            case 'ul':
              if(sel){
                insert = sel.split('\n').map(function(l){ return '* ' + l; }).join('\n');
              } else {
                insert = '\n* ';
              }
              cursorOffset = insert.length;
              break;
            case 'ol':
              if(sel){
                var n = 0;
                insert = sel.split('\n').map(function(l){ n++; return n + '. ' + l; }).join('\n');
              } else {
                insert = '\n1. ';
              }
              cursorOffset = insert.length;
              break;
            case 'quote':
              if(sel){
                insert = sel.split('\n').map(function(l){ return '> ' + l; }).join('\n');
              } else {
                insert = '\n> ';
              }
              cursorOffset = insert.length;
              break;
            case 'link':
              if(sel){
                insert = '[' + sel + '](url)';
                cursorOffset = insert.length - 1;
              } else {
                insert = '[Linktext](url)';
                cursorOffset = 1;
              }
              break;
            case 'code':
              if(sel && sel.indexOf('\n') !== -1){
                insert = '\n```\n' + sel + '\n```\n';
              } else {
                insert = '`' + (sel || 'code') + '`';
              }
              cursorOffset = sel ? insert.length : 1;
              break;
            case 'hr':
              insert = '\n---\n';
              cursorOffset = insert.length;
              break;
          }
          ta.value = before + insert + after;
          ta.focus();
          var pos = start + cursorOffset;
          ta.setSelectionRange(pos, pos);
        });

        function pollRebuild(){
          var iv = setInterval(function(){
            fetch('/api/content/_status',{credentials:'same-origin'})
              .then(function(r){ return r.json(); })
              .then(function(d){
                if(!d.rebuilding){
                  clearInterval(iv);
                  statusMsg.textContent = 'Fertig! Seite wird neu geladen...';
                  setTimeout(function(){ location.reload(); }, 1000);
                }
              })
              .catch(function(){ clearInterval(iv); });
          }, 2000);
        }
      })();
    </script>
  </body>
</html>
