server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html/public;
  index index.html;

  include /etc/nginx/conf.d/security-headers.inc;

  # Resolve Docker service names at request-time so gateway can start even
  # when optional auth backend container is not up yet.
  resolver 127.0.0.11 ipv6=off valid=30s;
  set $authelia_upstream authelia:9091;

  location = /healthz {
    access_log off;
    include /etc/nginx/conf.d/security-headers.inc;
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # Authelia portal (Iteration 5)
  location /auth/ {
    proxy_intercept_errors on;
    error_page 502 503 504 = @auth_unavailable;
    proxy_pass http://$authelia_upstream;
    proxy_set_header Host $host;
    proxy_set_header X-Original-URL https://$http_host$request_uri;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Uri $request_uri;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location = /internal/authelia/authz {
    internal;
    proxy_intercept_errors on;
    error_page 502 503 504 = @auth_unavailable;
    proxy_pass http://$authelia_upstream/auth/api/authz/auth-request;
    proxy_set_header Host $host;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URL https://$http_host$request_uri;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Uri $request_uri;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass_request_body off;
  }

  # Admin check endpoint for dynamic navigation (Iteration 9)
  # Returns 200 if user is admin, 401/403 otherwise.
  # Authelia access_control restricts this to group:admins.
  location = /api/admin-check {
    auth_request /internal/authelia/authz;
    error_page 401 403 500 = @auth_check_deny;
    default_type text/plain;
    alias /etc/nginx/conf.d/auth-ok.txt;
  }

  location @auth_check_deny {
    default_type text/plain;
    return 403 'denied';
  }

  location @auth_unavailable {
    include /etc/nginx/conf.d/security-headers.inc;
    add_header Content-Type text/plain;
    return 503 "auth backend unavailable; check authelia container and secrets";
  }

  # Remark42 static assets (no rate-limit)
  location /comments/web/ {
    include /etc/nginx/conf.d/security-headers.inc;
    proxy_pass http://remark42:8080/web/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Remark42 API (rate-limited)
  location /comments/ {
    include /etc/nginx/conf.d/security-headers.inc;
    limit_req zone=comments burst=3 nodelay;
    limit_req_status 429;

    proxy_pass http://remark42:8080/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Remark42 private static assets (Iteration 8: auth protected)
  location /comments-private/web/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;
    include /etc/nginx/conf.d/security-headers.inc;
    proxy_pass http://remark42-private:8080/web/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Remark42 private API (Iteration 8: auth protected, rate-limited)
  location /comments-private/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;
    include /etc/nginx/conf.d/security-headers.inc;
    limit_req zone=comments burst=3 nodelay;
    limit_req_status 429;
    proxy_pass http://remark42-private:8080/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # FreshRSS reader (Iteration 7: auth protected, owner only)
  location /reader/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;

    include /etc/nginx/conf.d/security-headers.inc;

    proxy_pass http://freshrss:80/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /reader;

    proxy_redirect off;
  }

  # Public surface (strict static files, no silent fallback to home)
  location / {
    set $clean_uri $uri;
    if ($clean_uri ~ "^(.+)/$") { set $clean_uri $1; }
    try_files $clean_uri $clean_uri/ $clean_uri/index.html =404;
  }

  # Explicit pretty-url routes for section MOCs
  location = /politik { return 301 /politik/; }
  location = /politik/ { try_files /politik/index.html =404; }

  location = /technik { return 301 /technik/; }
  location = /technik/ { try_files /technik/index.html =404; }

  location = /reisen { return 301 /reisen/; }
  location = /reisen/ { try_files /reisen/index.html =404; }

  location = /politik/dossier-iran { return 301 /politik/dossier-iran/; }
  location = /politik/dossier-iran/ { try_files /politik/dossier-iran/index.html =404; }

  # Private output (Iteration 5: auth protected)
  # Group authorization handled by Authelia access_control rules.
  location /private/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;

    alias /usr/share/nginx/html/private/;
    include /etc/nginx/conf.d/security-headers.inc;
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header X-Authenticated-User $auth_user always;
    index index.html;
    try_files $uri $uri/ =404;
  }

  location /g/friends/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;

    alias /usr/share/nginx/html/groups/friends/;
    include /etc/nginx/conf.d/security-headers.inc;
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header X-Authenticated-User $auth_user always;
    index index.html;
    try_files $uri $uri/ =404;
  }

  location /g/family/ {
    auth_request /internal/authelia/authz;
    auth_request_set $auth_user $upstream_http_remote_user;
    error_page 401 =302 /auth/?rd=$scheme://$http_host$request_uri;
    error_page 403 = @forbidden;

    alias /usr/share/nginx/html/groups/family/;
    include /etc/nginx/conf.d/security-headers.inc;
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header X-Authenticated-User $auth_user always;
    index index.html;
    try_files $uri $uri/ =404;
  }

  location @forbidden {
    include /etc/nginx/conf.d/security-headers.inc;
    add_header Content-Type text/plain;
    return 403 "access denied: you are not a member of the required group";
  }
}
