services:
  gateway:
    image: nginx:1.27-alpine
    container_name: mygarden-gateway
    ports:
      - "1234:80"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./out:/usr/share/nginx/html:ro

  hugo:
    image: ${HUGO_IMAGE:-klakegg/hugo:ext-alpine}
    container_name: mygarden-hugo
    working_dir: /workspace
    volumes:
      - ./:/workspace
    entrypoint: ["hugo"]

  content-api:
    image: python:3.11-alpine
    container_name: mygarden-content-api
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_API_VERSION=1.43
      - HOST_PROJECT_DIR=/volume1/docker/MyGarden
    expose:
      - "8000"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache docker-cli docker-cli-compose bash &&
        exec python -u api/server.py

  authelia:
    image: authelia/authelia:4.38
    container_name: mygarden-authelia
    volumes:
      - ./infra/authelia/configuration.yml:/config/configuration.yml:ro
      - ./infra/authelia/users_database.yml:/config/users_database.yml:ro
      - ./infra/authelia:/var/lib/authelia
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET:-replace-me-jwt-secret}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET:-replace-me-session-secret}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY:-replace-me-storage-key}
    expose:
      - "9091"

  remark42:
    image: umputun/remark42:latest
    container_name: mygarden-remark42
    environment:
      - REMARK_URL=https://karimi.me
      - SITE=mygarden
      - SECRET=${REMARK42_SECRET:-replace-me-remark-secret}
      - AUTH_ANON=true
      - AUTH_EMAIL_ENABLE=false
    volumes:
      - ./infra/remark42:/srv/var
    expose:
      - "8080"
    entrypoint: ["/srv/remark42"]
    command: ["server"]

  remark42-private:
    image: umputun/remark42:latest
    container_name: mygarden-remark42-private
    environment:
      - REMARK_URL=https://karimi.me
      - SITE=mygarden-private
      - SECRET=${REMARK42_PRIVATE_SECRET:-replace-me-remark-private-secret}
      - AUTH_ANON=true
      - AUTH_EMAIL_ENABLE=false
    volumes:
      - ./infra/remark42-private:/srv/var
    expose:
      - "8080"
    entrypoint: ["/srv/remark42"]
    command: ["server"]

  freshrss:
    image: freshrss/freshrss:latest
    container_name: mygarden-freshrss
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - CRON_MIN=13,43
      - FRESHRSS_BASE_URL=https://karimi.me/reader/
    volumes:
      - ./infra/freshrss:/var/www/FreshRSS/data
    expose:
      - "80"

  acme:
    image: neilpang/acme.sh:3.0.7
    container_name: acme-sh
    environment:
      - IONOS_PREFIX=${IONOS_PREFIX:-}
      - IONOS_SECRET=${IONOS_SECRET:-}
      - ACME_SERVER=${ACME_SERVER:-letsencrypt}
      - SYNO_HOSTNAME=${SYNO_HOSTNAME:-}
      - SYNO_PORT=${SYNO_PORT:-5001}
      - SYNO_SCHEME=${SYNO_SCHEME:-https}
      - SYNO_USERNAME=${SYNO_USERNAME:-}
      - SYNO_PASSWORD=${SYNO_PASSWORD:-}
      - SYNO_CERTIFICATE=${SYNO_CERTIFICATE:-}
      - SYNO_Username=${SYNO_USERNAME:-}
      - SYNO_Password=${SYNO_PASSWORD:-}
      - SYNO_Certificate=${SYNO_CERTIFICATE:-}
      - SYNO_Hostname=${SYNO_HOSTNAME:-}
      - SYNO_Port=${SYNO_PORT:-5001}
      - SYNO_Scheme=${SYNO_SCHEME:-https}
      - SYNO_DEVICE_ID=${SYNO_DEVICE_ID:-}
      - SYNO_Device_ID=${SYNO_DEVICE_ID:-}
      - SYNO_DEVICE_NAME=${SYNO_DEVICE_NAME:-}
      - SYNO_Device_Name=${SYNO_DEVICE_NAME:-}
      - SYNO_CREATE=${SYNO_CREATE:-1}
      - SYNO_Create=${SYNO_CREATE:-1}
    volumes:
      - ./acme.sh:/acme.sh
      - ./certs:/certs
    command: daemon
